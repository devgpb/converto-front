<ion-content>
  <div class="ion-padding">
    @if (loading()) {
      <ion-skeleton-text animated style="width:25%;height:32px"></ion-skeleton-text>
      <ion-grid class="ion-margin-top">
        <ion-row>
          @for (_ of [1,2,3,4]; track _) {
            <ion-col size="12" size-md="6" size-lg="3">
              <ion-card>
                <ion-skeleton-text animated style="height:128px"></ion-skeleton-text>
              </ion-card>
            </ion-col>
          }
        </ion-row>
      </ion-grid>
    }

    @if (!loading() && error()) {
      <ion-text color="medium" class="ion-text-center">{{ error() }}</ion-text>
    }

    @if (!loading() && data(); as d) {
      <div class="header">
        <div>
          <p>Acompanhe o desempenho do atendimento ao cliente</p>
        </div>
        <div class="filters">
          <ion-item class="range-picker" style="display:none">
            <ion-input
              type="date"
              [value]="range.start"
              (ionChange)="onRangeChange('start', $event.detail.value ?? '')"
              placeholder="Início">
            </ion-input>
          </ion-item>
          <ion-item class="range-picker" style="display:none">

            <ion-input
              type="date"
              [value]="range.end"
              (ionChange)="onRangeChange('end', $event.detail.value ?? '')"
              placeholder="Fim">
            </ion-input>
          </ion-item>
          <app-date-field
            label="Período"
            mode="range"
            [start]="range.start"
            [end]="range.end"
            (startChange)="onRangeChange('start', $event || '')"
            (endChange)="onRangeChange('end', $event || '')"
          ></app-date-field>
          <ion-button fill="outline" [disabled]="!rangeValid" (click)="applyRange()">Aplicar</ion-button>
          <ion-text color="danger" *ngIf="rangeError">{{ rangeError }}</ion-text>
        </div>
        <div class="filters">
          <ion-button size="small" fill="outline" [color]="selectedPeriod()==='hoje' ? 'primary' : undefined" (click)="setPeriod('hoje')">Hoje</ion-button>
          <ion-button size="small" fill="outline" [color]="selectedPeriod()==='semana' ? 'primary' : undefined" (click)="setPeriod('semana')">Esta Semana</ion-button>
          <ion-button size="small" fill="outline" [color]="selectedPeriod()==='mes' ? 'primary' : undefined" (click)="setPeriod('mes')">Este Mês</ion-button>
        </div>
        <div class="filters">
          <ion-text color="medium" *ngIf="d?.periodo as p">Período aplicado: {{ formatDate(p.inicio) }} — {{ formatDate(p.fim) }}</ion-text>
        </div>
      </div>

      <ion-grid class="kpi-grid">
        <ion-row>
          <ion-col size="12" size-md="6" size-lg="3">
            <ion-card class="kpi-card novos" (click)="openModal('novos')">
              <ion-card-header>
                <ion-card-subtitle>Clientes Novos</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-icon name="person-add-outline"></ion-icon>
                <div class="kpi-value">{{ d.clientesNovosHoje }}</div>
                <div class="kpi-desc">{{ selectedPeriod()==='hoje' ? 'hoje' : ('neste ' + selectedPeriod()) }}</div>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <ion-col size="12" size-md="6" size-lg="3">
            <ion-card class="kpi-card atendidos" (click)="openModal('atendidos')">
              <ion-card-header>
                <ion-card-subtitle>Clientes Atendidos</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-icon name="chatbubbles-outline"></ion-icon>
                <div class="kpi-value">{{ d.clientesAtendidosHoje }}</div>
                <div class="kpi-desc">{{ selectedPeriod()==='hoje' ? 'hoje' : ('neste ' + selectedPeriod()) }}</div>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <!-- <ion-col size="12" size-md="6" size-lg="3">
            <ion-card class="kpi-card total">
              <ion-card-header>
                <ion-card-subtitle>Total Cadastrados</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-icon name="people-outline"></ion-icon>
                <div class="kpi-value">{{ d.totalClientesCadastrados }}</div>
                <div class="kpi-desc">clientes ativos</div>
              </ion-card-content>
            </ion-card>
          </ion-col> -->

          <ion-col size="12" size-md="6" size-lg="3">
            <ion-card class="kpi-card eventos" (click)="openModal('eventos')">
              <ion-card-header>
                <ion-card-subtitle>Eventos Marcados</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-icon name="calendar-outline"></ion-icon>
                <div class="kpi-value">{{ d.eventosMarcados }}</div>
                <div class="kpi-desc">Eventos marcados</div>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <ion-col size="12" size-md="6" size-lg="3">
            <ion-card class="kpi-card fechados" (click)="openModal('fechados')">
              <ion-card-header>
                <ion-card-subtitle>Fechados</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-icon name="checkmark-done-outline"></ion-icon>
                <div class="kpi-value">{{ d.clientesFechados }}</div>
                <div class="kpi-desc">Vendas Fechadas</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="12" size-md="6" size-lg="3">
            <ion-card class="kpi-card" (click)="openModal('ligacoes')">
              <ion-card-header>
                <ion-card-subtitle>Ligações Efetuadas</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <ion-icon name="call-outline"></ion-icon>
                <div class="kpi-value">{{ d.ligacoesEfetuadas || 0 }}</div>
                <div class="kpi-desc">No período selecionado</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid>
        <ion-row>
          <ion-col size="12" size-lg="6">
            <ion-card>
              <ion-card-header>
                <ion-card-subtitle>Clientes por Status</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content *ngIf="statusChart() as s">
                <apx-chart [series]="s.series" [chart]="s.chart" [xaxis]="s.xaxis" [plotOptions]="s.plotOptions" [dataLabels]="s.dataLabels" [stroke]="s.stroke" [tooltip]="s.tooltip" [fill]="s.fill"></apx-chart>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <ion-col size="12" size-lg="6">
            <ion-card>
              <ion-card-header>
                <ion-card-subtitle>Clientes por Campanha</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content *ngIf="campanhaChart() as c">
                <apx-chart [series]="c.series" [chart]="c.chart" [labels]="c.labels" [legend]="c.legend" [tooltip]="c.tooltip" [responsive]="c.responsive"></apx-chart>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <ion-col size="6" size-lg="6">
            <ion-card>
              <ion-card-header>
                <ion-card-subtitle>Contatos por dia (último contato)</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content *ngIf="contatosChart() as ct">
                <apx-chart [series]="ct.series" [chart]="ct.chart" [xaxis]="ct.xaxis" [dataLabels]="ct.dataLabels" [stroke]="ct.stroke" [tooltip]="ct.tooltip" [fill]="ct.fill"></apx-chart>
              </ion-card-content>
            </ion-card>
          </ion-col>

           <ion-col size="12" size-lg="6">
            <ion-card>
              <ion-card-header>
                <ion-card-subtitle>Ligações por dia</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content *ngIf="ligacoesChart() as lg">
                <apx-chart [series]="lg.series" [chart]="lg.chart" [xaxis]="lg.xaxis" [dataLabels]="lg.dataLabels" [stroke]="lg.stroke" [tooltip]="lg.tooltip" [fill]="lg.fill"></apx-chart>
              </ion-card-content>
            </ion-card>
          </ion-col>
          
        </ion-row>
      </ion-grid>
    }

    <ion-modal [isOpen]="modalOpen()" (didDismiss)="closeModal()">
      <ng-template>
        <ion-content class="ion-padding">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold">{{ modalTitle() }}</h2>
            <ion-button fill="clear" (click)="closeModal()">Fechar</ion-button>
          </div>

          @if (modalLoading()) {
            @for (_ of [1,2,3,4,5,6]; track _) {
              <ion-skeleton-text animated style="height:64px" class="ion-margin-vertical"></ion-skeleton-text>
            }
          } @else if (modalError()) {
            <ion-text color="danger">{{ modalError() }}</ion-text>
          } @else if (modalItems().length === 0) {
            <ion-text color="medium">Nenhum registro no período.</ion-text>
          } @else {
            @if (isClientList()) {
              <ion-list>
                @for (c of modalItems(); track c['nome'] + c['updatedAt']) {
                  <ion-item lines="full">
                    <ion-label class="ion-text-wrap">
                      <h3>{{ c['nome'] }}</h3>
                      <p class="ion-text-xs">Atualizado em {{ formatDate(c['updatedAt']) }}</p>
                      @if (c['fechado']) {
                        <p class="ion-text-xs">fechado {{ formatDate(c['fechado']) }}</p>
                      }
                      @if (c['ultimoContato']) {
                        <p class="ion-text-xs">Contato Mais Recente {{ formatDate(c['ultimoContato']) }}</p>
                      }
                      <p>{{ short(c['observacao']) }}</p>
                    </ion-label>
                    <ion-badge slot="end" [class]="statusPillClass(c['status'])">{{ c['status'] || 'Sem status' }}</ion-badge>
                  </ion-item>
                }
              </ion-list>
            } @else if (modalKind()==='ligacoes') {
              <ion-list>
                @for (l of modalItems(); track (l['idLigacao'] || (l['data'] || '') + (l['cliente']?.nome || ''))) {
                  <ion-item lines="full">
                    <ion-label class="ion-text-wrap">
                      <h3>Cliente: {{ l['cliente']?.nome || '-' }} | Data: {{ formatDate(l['data'] || l['dataHora']) }}</h3>
                      @if (l['observacao']) {
                        <p>Observação: {{ short(l['observacao']) }}</p>
                      }
                      <p class="ion-text-xs">Vendedor: {{ l['usuario']?.nomeCompleto || l['usuario']?.name || '-' }}</p>
                    </ion-label>
                    <ion-badge slot="end" [color]="l['atendida'] ? 'success' : 'medium'">{{ l['atendida'] ? 'Atendido' : 'Não atendeu' }}</ion-badge>
                  </ion-item>
                }
              </ion-list>
            } @else {
              <ion-list>
                @for (e of modalItems(); track e['data'] + (e['usuario']?.nome || '')) {
                  <ion-item lines="full">
                    <ion-label class="ion-text-wrap">
                      <h3>Cliente: {{e['cliente']?.nome || '-'}} | Data: {{ formatDate(e['data']) }}</h3>
                      <p>Evento: {{ e['evento'] || '-' }}</p>
                      <p class="ion-text-xs">Usuário: {{ e['usuario']?.nomeCompleto || '-' }}</p>
                    </ion-label>
                    <ion-badge slot="end" [color]="e['confirmado'] ? 'success' : 'medium'">{{ e['confirmado'] ? 'Confirmado' : 'Pendente' }}</ion-badge>
                  </ion-item>
                }
              </ion-list>
            }

            @if (modalMeta(); as m) {
              <ion-row class="ion-justify-content-between ion-align-items-center ion-padding-top">
                <ion-col size="12" class="ion-text-center">
                  <ion-text color="medium">Página {{ m.page }} de {{ m.totalPages }} — {{ m.total }} registros</ion-text>
                </ion-col>
                <ion-col size="12" class="ion-text-center">
                  <ion-button size="small" fill="outline" [disabled]="modalLoading() || m.page <= 1" (click)="prevPage()">Anterior</ion-button>
                  <ion-button size="small" fill="outline" [disabled]="modalLoading() || m.page >= m.totalPages" (click)="nextPage()">Próxima</ion-button>
                </ion-col>
              </ion-row>
            }
          }
        </ion-content>
      </ng-template>
    </ion-modal>
  </div>
</ion-content>

