<div class="menu-wrapper">
  <div
    class="collapse-toggle"
    (click)="toggleCollapse()"
    (keydown.enter)="toggleCollapse()"
    (keydown.space)="toggleCollapse()"
    role="button"
    tabindex="0"
    aria-label="Alternar menu"
  >
    <img src="assets/img/logo.png" alt="Logo" class="collapse-logo" />
    <ion-icon class="collapse-chevron" [name]="collapsed ? 'chevron-forward-outline' : 'chevron-back-outline'"></ion-icon>
  </div>
  <div class="menu-sections">
    <ng-container *ngFor="let section of menuSections">
    <ion-list *ngIf="!isAdminSection(section) || isAdmin()">
      <button type="button"
              class="section-header"
              (click)="toggleSection(section.title)"
              [class.collapsed]="isSectionCollapsed(section.title)"
              [attr.aria-expanded]="!isSectionCollapsed(section.title)">
              <span class="section-letter" *ngIf="collapsed">{{ (section.title | slice:0:1 | uppercase) || '' }}</span>
        <ion-icon class="section-arrow" [name]="isSectionCollapsed(section.title) ? 'chevron-forward-outline' : 'chevron-down-outline'"></ion-icon>
        <span class="section-title">{{ section.title }}</span>
      </button>
      <div class="section-items" *ngIf="!isSectionCollapsed(section.title)">
        <ng-container *ngFor="let item of section.items">
          <ng-container *ngIf="item.hasSubmenu; else regularItem">
            <ion-accordion-group>
              <ion-accordion value="{{ item.title }}">
                <ion-item class="start" slot="header">
                  <ion-icon slot="start" [name]="item.icon"></ion-icon>
                  <ion-label>{{ item.title }}</ion-label>
                </ion-item>
                <ion-list slot="content">
                  <ion-item *ngFor="let sub of getSubItems(item.title)" [routerLink]="[sub.route]" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
                    <ion-icon slot="start" class="ml-1" [name]="sub.icon"></ion-icon>
                    <ion-label>{{ sub.title }}</ion-label>
                  </ion-item>
                </ion-list>
              </ion-accordion>
            </ion-accordion-group>
          </ng-container>
          <ng-template #regularItem>
            <ion-menu-toggle auto-hide="false">
              <ion-item [routerLink]="[item.href]" lines="none" detail="false" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
                <ion-icon slot="start" [name]="item.icon"></ion-icon>
                <ion-label>{{ item.title }}</ion-label>
              </ion-item>
            </ion-menu-toggle>
          </ng-template>
        </ng-container>
      </div>
    </ion-list>
    </ng-container>
  </div>
  <div class="user-actions">
    <!-- Expandido: linha com perfil (ícone + nome), e ícones de config e suporte -->
    <div class="user-actions-row" *ngIf="!collapsed; else collapsedActions">
      <button class="profile-trigger" (click)="toggleProfileOverlay()" aria-label="Abrir menu de perfil">
        <ion-icon name="person-circle"></ion-icon>
        <span class="user-name">{{ profile?.name || 'Usuário' }}</span>
      </button>
    </div>

    <!-- Colapsado: apenas ícone de perfil -->
    <ng-template #collapsedActions>
      <div class="user-actions-collapsed">
        <button id="profile-collapsed-trigger" class="profile-icon" aria-label="Abrir menu de perfil">
          <ion-icon name="person-circle"></ion-icon>
        </button>
      </div>
    </ng-template>

    <!-- Overlay expandido: opções perfil/sair -->
    <div class="profile-overlay-backdrop" *ngIf="showProfileOverlay && !collapsed" (click)="closeOverlays()">
      <div class="profile-overlay-card" (click)="$event.stopPropagation()">
        <div class="overlay-header">
          <ion-icon name="person-circle"></ion-icon>
          <div class="details">
            <div class="name">{{ profile?.name || 'Usuário' }}</div>
            <div class="email" *ngIf="profile?.email">{{ profile?.email }}</div>
          </div>
        </div>
        <ion-item button detail="false" (click)="goToPerfil()">
          <ion-icon slot="start" name="person-outline"></ion-icon>
          <ion-label>Ver perfil</ion-label>
        </ion-item>
        <ion-item button detail="false" (click)="goToConfig()">
          <ion-icon slot="start" name="settings"></ion-icon>
          <ion-label>Configurações</ion-label>
        </ion-item>
        <ion-item button detail="false" (click)="logout()">
          <ion-icon slot="start" name="log-out"></ion-icon>
          <ion-label>Sair</ion-label>
        </ion-item>
      </div>
    </div>

    <!-- Popover para barra colapsada (segue o trigger do botão) -->
    <ion-popover
       #collapsedProfilePopover
      trigger="profile-collapsed-trigger"
      triggerAction="click"
      side="top"
      alignment="start"
      showBackdrop="true"
      arrow="true"
    >
      <ng-template>
        <ion-content class="popover-content">
          <div class="collapsed-header">
            <ion-icon name="person-circle"></ion-icon>
            <div class="name">{{ profile?.name || 'Usuário' }}</div>
          </div>
          <ion-list>
            <ion-item button detail="false" (click)="goToPerfil(); collapsedProfilePopover.dismiss()">
              <ion-icon slot="start" name="person-outline"></ion-icon>
              <ion-label>Ver perfil</ion-label>
            </ion-item>
            <ion-item button detail="false" (click)="goToConfig(); collapsedProfilePopover.dismiss()">
              <ion-icon slot="start" name="settings"></ion-icon>
              <ion-label>Configurações</ion-label>
            </ion-item>
            <ion-item button detail="false" (click)="goToSuporte(); collapsedProfilePopover.dismiss()">
              <ion-icon slot="start" name="help-circle"></ion-icon>
              <ion-label>Suporte</ion-label>
            </ion-item>
            <ion-item button detail="false" (click)="logout(); collapsedProfilePopover.dismiss()">
              <ion-icon slot="start" name="log-out"></ion-icon>
              <ion-label>Sair</ion-label>
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>
  </div>
</div>
