<div class="menu-wrapper">
  <header class="menu-header" (click)="toggleCollapse()">
    <div class="brand" aria-label="Logo Converto">
      <img src="assets/img/logo.png" alt="Converto" class="brand-logo" />
      <div class="brand-text">
        <span class="brand-title">Converto</span>
        <span class="brand-subtitle">Plataforma</span>
      </div>
    </div>
    <button
      type="button"
      class="collapse-button"
      [attr.aria-label]="collapsed ? 'Expandir menu lateral' : 'Recolher menu lateral'"
      [attr.aria-pressed]="collapsed"
      [attr.title]="collapsed ? 'Expandir menu' : 'Recolher menu'"
    >
      <ion-icon [name]="collapsed ? 'chevron-forward-outline' : 'chevron-back-outline'"></ion-icon>
    </button>
    <ion-menu-toggle auto-hide="false" class="header-close">
      <ion-button fill="clear" size="small" class="close-button" aria-label="Fechar menu de navegação">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-menu-toggle>
  </header>

  <div class="menu-scroll" role="navigation" aria-label="Menu principal">
    <ng-container *ngFor="let section of menuSections">
      <ion-list *ngIf="!isAdminSection(section) || isAdmin()" lines="none" class="menu-section">
        <button
          type="button"
          class="section-header"
          (click)="toggleSection(section.title)"
          [attr.aria-expanded]="!isSectionCollapsed(section.title)"
          [attr.title]="collapsed ? section.title : null"
        >
          <span class="section-letter" *ngIf="collapsed">{{ section.title | slice:0:1 | uppercase }}</span>
          <ion-icon class="section-arrow" [name]="isSectionCollapsed(section.title) ? 'chevron-forward-outline' : 'chevron-down-outline'"></ion-icon>
          <span class="section-title">{{ section.title }}</span>
        </button>

        <div class="section-items" *ngIf="!isSectionCollapsed(section.title)">
          <ng-container *ngFor="let item of section.items">
            <ng-container *ngIf="item.hasSubmenu; else regularItem">
              <ion-accordion-group>
                <ion-accordion [value]="item.title">
                  <ion-item class="submenu-trigger" slot="header" lines="none">
                    <ion-icon slot="start" [name]="item.icon"></ion-icon>
                    <ion-label>{{ item.title }}</ion-label>
                  </ion-item>
                  <ion-list slot="content" class="submenu-list">
                    <ion-menu-toggle auto-hide="false" *ngFor="let sub of getSubItems(item.title)">
                      <ion-item
                        lines="none"
                        [routerLink]="[sub.route]"
                        routerLinkActive="active"
                        [routerLinkActiveOptions]="{ exact: true }"
                        [attr.title]="collapsed ? sub.title : null"
                      >
                        <ion-icon slot="start" [name]="sub.icon"></ion-icon>
                        <ion-label>{{ sub.title }}</ion-label>
                      </ion-item>
                    </ion-menu-toggle>
                  </ion-list>
                </ion-accordion>
              </ion-accordion-group>
            </ng-container>
            <ng-template #regularItem>
              <ion-menu-toggle auto-hide="false">
                <ion-item
                  [routerLink]="[item.href]"
                  lines="none"
                  detail="false"
                  routerLinkActive="active"
                  [routerLinkActiveOptions]="{ exact: true }"
                  [attr.title]="collapsed ? item.title : null"
                >
                  <ion-icon slot="start" [name]="item.icon"></ion-icon>
                  <ion-label>{{ item.title }}</ion-label>
                </ion-item>
              </ion-menu-toggle>
            </ng-template>
          </ng-container>
        </div>
      </ion-list>
    </ng-container>
  </div>

  <div class="user-actions">
    <div class="user-actions-row">
      <button
        class="profile-trigger"
        (click)="toggleProfileOverlay()"
        aria-label="Abrir menu de perfil"
        [attr.title]="collapsed ? (profile?.name || 'Perfil') : null"
      >
        <ion-icon name="person-circle"></ion-icon>
        <span class="user-name">{{ profile?.name || 'Usuário' }}</span>
      </button>
    </div>

    <div class="profile-overlay-backdrop" *ngIf="showProfileOverlay" (click)="closeOverlays()">
      <div class="profile-overlay-card" (click)="$event.stopPropagation()">
        <div class="overlay-header">
          <ion-icon name="person-circle"></ion-icon>
          <div class="details">
            <div class="name">{{ profile?.name || 'Usuário' }}</div>
            <div class="email" *ngIf="profile?.email">{{ profile?.email }}</div>
          </div>
        </div>
        <ion-item button detail="false" (click)="goToPerfil()">
          <ion-icon slot="start" name="person-outline"></ion-icon>
          <ion-label>Ver perfil</ion-label>
        </ion-item>
        <ion-item button detail="false" (click)="goToConfig()">
          <ion-icon slot="start" name="settings"></ion-icon>
          <ion-label>Configurações</ion-label>
        </ion-item>
        <ion-item button detail="false" (click)="goToSuporte()">
          <ion-icon slot="start" name="help-circle"></ion-icon>
          <ion-label>Suporte</ion-label>
        </ion-item>
        <ion-item button detail="false" (click)="logout()">
          <ion-icon slot="start" name="log-out"></ion-icon>
          <ion-label>Sair</ion-label>
        </ion-item>
      </div>
    </div>
  </div>
</div>
