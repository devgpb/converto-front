<ion-content class="ion-padding">
  <!-- Header -->
  <div class="header ion-margin-bottom">
    <div class="title">
      <ion-icon name="construct-outline" color="primary"></ion-icon>
      <h1>Trabalhos</h1>
    </div>
    <ion-note>
      <ng-container *ngIf="total > 0">
        Mostrando {{ startIndex }} – {{ endIndex }} de {{ total }} trabalhos
      </ng-container>
      <ng-container *ngIf="total === 0">0 de 0 trabalhos</ng-container>
    </ion-note>
  </div>

  <!-- Filtros -->
  <ion-card class="ion-margin-bottom">
    <ion-card-content>
      <ion-grid>
        <ion-row class="ion-align-items-end">
          <ion-col size="12" size-md="6">
            <ion-searchbar [(ngModel)]="searchTerm" placeholder="Pesquisar por ID, fila, estado..."></ion-searchbar>
          </ion-col>

          <ion-col size="6" size-md="3">
            <ion-item lines="none">
              <ion-label>Por página</ion-label>
              <ion-select [ngModel]="pageSize" (ngModelChange)="changePageSize($event)">
                <ion-select-option [value]="10">10</ion-select-option>
                <ion-select-option [value]="20">20</ion-select-option>
                <ion-select-option [value]="50">50</ion-select-option>
                <ion-select-option [value]="100">100</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>

          <ion-col size="12" class="ion-text-right">
            <ion-button color="primary" (click)="pesquisaAvancada(true)" [disabled]="loading">
              <ion-spinner slot="start" *ngIf="loading" name="crescent"></ion-spinner>
              Buscar
            </ion-button>
          </ion-col>

          <ion-col size="12" class="ion-text-right" *ngIf="searchTerm">
            <ion-button fill="clear" (click)="clearFilters()">Limpar filtros</ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Resultados</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="ion-text-center" *ngIf="loading">
        <ion-spinner name="crescent"></ion-spinner>
      </div>
      <ion-grid class="jobs-grid" *ngIf="!loading">
        <ion-row class="header">
          <ion-col>Fila</ion-col>
          <ion-col>ID</ion-col>
          <ion-col>Estado</ion-col>
          <ion-col>Data</ion-col>
          <ion-col>Ações</ion-col>
        </ion-row>
        <ion-row *ngFor="let job of jobs">
          <ion-col>{{ translateQueue(job.queue || job.queueName) }}</ion-col>
          <ion-col>{{ job.id }}</ion-col>
          <ion-col>
            <ion-badge class="state-badge" [color]="statusColor(job.state)">
              {{ translateState(job) }}
            </ion-badge>
          </ion-col>
          <ion-col>
            {{ (job.requestedAt || job.timestamp) | date:'dd/MM/yyyy HH:mm' }}
          </ion-col>
          <ion-col>
            <ng-container *ngIf="isExport(job) && job.state === 'completed'; else defaultActions">
              <ion-button size="small"
                          (click)="downloadExport(job)"
                          [disabled]="!getExportLink(job) || isExpired(job)">
                Baixar CSV
              </ion-button>
              <ion-text color="medium" *ngIf="getExportExpiry(job) as expires" style="margin-left: 8px;">
                <ng-container *ngIf="!isExpired(job); else expiredTpl">
                  expira em {{ expires | date:'short' }}
                </ng-container>
                <ng-template #expiredTpl>
                  link expirado
                </ng-template>
              </ion-text>
            </ng-container>
            <ng-template #defaultActions>
              <ion-button size="small" (click)="viewData(job)" [disabled]="job.state !== 'completed'">
                Ver Dados
              </ion-button>
            </ng-template>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Paginação -->
  <div class="pagination ion-margin-top">
    <ion-note>Página {{ page }} de {{ totalPages }}</ion-note>
    <ion-buttons>
      <ion-button (click)="goToPage(1)" [disabled]="page === 1">« Primeiro</ion-button>
      <ion-button (click)="goToPage(page - 1)" [disabled]="page === 1">‹ Anterior</ion-button>
      <ion-button (click)="goToPage(page + 1)" [disabled]="page === totalPages || totalPages === 0">Próximo ›</ion-button>
      <ion-button (click)="goToPage(totalPages)" [disabled]="page === totalPages || totalPages === 0">Último »</ion-button>
    </ion-buttons>
  </div>
  <ion-modal [isOpen]="metadataOpen" (didDismiss)="closeMetadata()" cssClass="job-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Dados do Trabalho</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeMetadata()">
              <ion-icon slot="icon-only" name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div class="ion-text-center" *ngIf="metadataLoading">
          <ion-spinner name="crescent"></ion-spinner>
        </div>

        <!-- Detalhes completos: cards com resumo, erros e dados tÃ©cnicos -->
        <div *ngIf="!metadataLoading">
          <ion-card class="ion-margin-top">
            <ion-card-header>
              <ion-card-subtitle>
                {{ translateQueue(selectedJob?.queue || selectedJob?.queueName) }} Job ID {{ selectedJob?.id }}
              </ion-card-subtitle>
              <ion-card-title>
                <ion-badge [color]="statusColor(selectedJob?.state || jobDetails?.state)">
                  {{ translateState(selectedJob || jobDetails) }}
                </ion-badge>
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-grid>
              
                <ion-row>
                  <ion-col size="12" size-md="6">
                    <ion-note>Solicitado em:</ion-note>
                    <div>{{ (selectedJob?.requestedAt || selectedJob?.timestamp) | date:'dd/MM/yyyy HH:mm' }}</div>
                  </ion-col>
                  <ion-col size="12" size-md="6" *ngIf="isExport(selectedJob)">
                    <ion-note>Expira em:</ion-note>
                    <div>{{ getExportExpiry(selectedJob) || jobDetails?.result?.expiresAt | date:'dd/MM/yyyy HH:mm' }}</div>
                  </ion-col>
                </ion-row>
              </ion-grid>
              <div *ngIf="isExport(selectedJob) && (getExportLink(selectedJob) || jobDetails?.result?.signedUrl)" class="ion-margin-top">
                <ion-button color="primary" (click)="downloadExport(selectedJob)">Baixar CSV</ion-button>
              </div>
            </ion-card-content>
          </ion-card>

          <ion-card *ngIf="jobDetails?.result?.summary as sum">
            <ion-card-header>
              <ion-card-title>Resumo</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-grid>
                <ion-row>
                  <ion-col size="12" size-md="3"><ion-chip color="success">Criados: {{ sum.criados || 0 }}</ion-chip></ion-col>
                  <ion-col size="12" size-md="3"><ion-chip color="tertiary">Atualizados: {{ sum.atualizados || 0 }}</ion-chip></ion-col>
                  <ion-col size="12" size-md="3"><ion-chip color="medium">Pulados: {{ sum.pulados || 0 }}</ion-chip></ion-col>
                  <ion-col size="12" size-md="3"><ion-chip color="danger">Erros: {{ (sum.erros?.length || 0) }}</ion-chip></ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>

          <ion-card *ngIf="jobErrors?.length">
            <ion-card-header>
              <ion-card-title>Erros</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-grid class="metadata-grid">
                <ion-row class="header">
                  <ion-col size="3">Linha</ion-col>
                  <ion-col>Motivo</ion-col>
                </ion-row>
                <ion-row *ngFor="let e of jobErrors">
                  <ion-col size="3">{{ e.linha ?? '-' }}</ion-col>
                  <ion-col>{{ e.motivo }}</ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </div>
        <ion-text color="medium" *ngIf="!metadataLoading && metadata.length === 0">
          Nenhum dado disponÃ­vel.
        </ion-text>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>

