<ion-modal [isOpen]="isOpen" (didDismiss)="close()" class="cliente-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Cliente #{{ formData?.id_cliente }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="close()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding" *ngIf="formData">
      <!-- Informações fixas -->
      <ion-card class="info-card">
        <ion-card-content>
          <ion-item lines="none">
            <ion-icon slot="start" name="person-circle-outline"></ion-icon>
            <ion-label>
              <p>Cadastrado por</p>
              <h2>{{ formData.responsavel?.name || '-' }}</h2>
            </ion-label>
          </ion-item>
          <ion-item lines="none">
            <ion-icon slot="start" name="calendar-outline" color="primary"></ion-icon>
            <ion-label>
              <p>Data de Criação</p>
              <h3>{{ formData.created_at | date: 'dd/MM/yyyy HH:mm' }}</h3>
            </ion-label>
          </ion-item>
          <ion-item lines="none">
            <ion-icon slot="start" name="refresh-outline" color="success"></ion-icon>
            <ion-label>
              <p>Última Atualização</p>
              <h3>{{ formData.updated_at | date: 'dd/MM/yyyy HH:mm' }}</h3>
            </ion-label>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <!-- Formulário de edição -->
      <ion-list lines="full">
        <ion-item>
          <ion-label position="stacked">Nome *</ion-label>
          <ion-input [(ngModel)]="formData.nome" [class.ion-invalid]="errors['nome']"></ion-input>
          <ion-note slot="error" color="danger" *ngIf="errors['nome']">{{ errors['nome'] }}</ion-note>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Celular *</ion-label>
          <ion-input [(ngModel)]="formData.celular" [class.ion-invalid]="errors['celular']" type="tel"></ion-input>
          <ion-note slot="error" color="danger" *ngIf="errors['celular']">{{ errors['celular'] }}</ion-note>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Cidade</ion-label>
          <ion-select [(ngModel)]="formData.cidade" interface="popover" placeholder="Selecionar ou digitar">
            <ion-select-option *ngFor="let c of cidades" [value]="c">{{ c }}</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Status</ion-label>
          <ion-select [(ngModel)]="formData.status" interface="popover" placeholder="Selecionar ou digitar">
            <ion-select-option *ngFor="let s of statuses" [value]="s">{{ s }}</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Campanha</ion-label>
          <ion-select [(ngModel)]="formData.campanha" interface="popover" placeholder="Selecionar ou digitar">
            <ion-select-option *ngFor="let c of campanhas" [value]="c">{{ c }}</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Indicação</ion-label>
          <ion-input [(ngModel)]="formData.indicacao"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Observações</ion-label>
          <ion-textarea rows="3" [(ngModel)]="formData.observacao"></ion-textarea>
        </ion-item>
      </ion-list>

      <!-- Eventos -->
      <ion-card class="ion-margin-top">
        <ion-card-header>
          <ion-card-title>Eventos do Cliente</ion-card-title>
          <ion-card-subtitle>{{ eventos.length }} registro(s)</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-input placeholder="Título do evento" [(ngModel)]="evTitulo"></ion-input>
          </ion-item>
          <div class="datetime-container">
            <ion-item lines="none" class="datetime-item">
              <ion-label position="stacked" class="ion-text-center">Data</ion-label>
              <ion-datetime
                class="centered-datetime"
                presentation="date"
                [preferWheel]="false"
                locale="pt-BR"
                [(ngModel)]="evDate"
              ></ion-datetime>
            </ion-item>
            <ion-item lines="none" class="datetime-item">
              <ion-label position="stacked" class="ion-text-center">Hora (opcional)</ion-label>
              <ion-datetime
                class="centered-datetime"
                presentation="time"
                [preferWheel]="true"
                locale="pt-BR"
                [(ngModel)]="evTime"
              ></ion-datetime>
            </ion-item>
          </div>
          <ion-text color="medium" class="event-hint">
            * Se não informar hora, será considerado 00:00 no seu fuso
            (America/Fortaleza).
          </ion-text>
          <ion-button expand="block" (click)="marcarEvento()" [disabled]="isSavingEvento">
            <ion-icon slot="start" name="calendar-outline"></ion-icon>
            Marcar
          </ion-button>
        </ion-card-content>
      </ion-card>

      <ng-container *ngIf="eventos.length > 0">
        <ion-card *ngFor="let ev of eventos" class="ion-margin-bottom">
          <ion-item lines="none">
            <ion-icon slot="start" name="time-outline"></ion-icon>
            <ion-label>
              <h2>{{ ev.dataLocal }}</h2>
              <p>{{ ev.evento || 'Evento sem título' }}</p>
            </ion-label>
            <ion-badge slot="end" [color]="ev.confirmado === null ? 'warning' : ev.confirmado ? 'success' : 'danger'">
              {{ ev.confirmado === null ? 'Pendente' : ev.confirmado ? 'Confirmado' : 'Cancelado' }}
            </ion-badge>
          </ion-item>
          <ion-card-content>
            <ion-button size="small" color="success" expand="block" *ngIf="ev.confirmado === null" (click)="confirmarEventoLocal(ev)">
              <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
              Confirmar
            </ion-button>
            <ion-button size="small" color="medium" expand="block" *ngIf="ev.confirmado === null" (click)="cancelarEventoLocal(ev)">
              <ion-icon slot="start" name="close-circle-outline"></ion-icon>
              Cancelar
            </ion-button>
          </ion-card-content>
        </ion-card>
      </ng-container>
      <ion-text color="medium" *ngIf="!isLoadingEventos && eventos.length === 0">Nenhum evento cadastrado.</ion-text>

      <div class="dias" *ngIf="formData.created_at">
        Criado há {{ calcularDias(formData.created_at) }} {{ calcularDias(formData.created_at) === 1 ? 'dia' : 'dias' }}
        <ion-badge [color]="getBadgeColor(calcularDias(formData.created_at))" class="ion-margin-start">
          {{ getBadgeText(calcularDias(formData.created_at)) }}
        </ion-badge>
      </div>
    </ion-content>

    <ion-footer class="ion-padding">
      <ion-button expand="block" (click)="save()" [disabled]="isLoading">
        <ion-spinner slot="start" *ngIf="isLoading" name="crescent"></ion-spinner>
        Salvar
      </ion-button>
      <ion-button expand="block" fill="clear" (click)="close()">Cancelar</ion-button>
    </ion-footer>
  </ng-template>
</ion-modal>
